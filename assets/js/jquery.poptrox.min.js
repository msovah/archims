// Zminimalizowany i poprawiony poptrox z natywnym <img> do pinch zoom
(function($) {
  $.fn.poptrox = function(options) {
    if (this.length == 0) return $(this);
    if (this.length > 1) {
      this.each(function() {
        $(this).poptrox(options);
      });
      return this;
    }

    var settings = $.extend({
      selector: 'a',
      popupClass: 'poptrox-popup',
      usePopupDefaultStyling: true,
      usePopupCloser: true,
      usePopupCaption: false,
      usePopupNav: false,
      overlayColor: '#000',
      overlayOpacity: 0.75,
      popupWidth: 0,
      popupHeight: 0,
      popupSpeed: 300,
      usePopupForceClose: true,
      caption: null,
      windowMargin: (window.innerWidth < 600 ? 5 : 50)
    }, options);

    var $body = $('body'), $window = $(window), $this = $(this),
        $overlay = $('<div class="poptrox-overlay"></div>').hide(),
        $popup = $('<div class="' + settings.popupClass + '"><div class="pic"></div><span class="closer">&#215;</span></div>').hide(),
        $pic = $popup.find('.pic'), $closer = $popup.find('.closer'),
        items = [], index = 0;

    $this.find(settings.selector).each(function(i) {
      var $a = $(this), $img = $a.find('img'), src = $a.attr('href');
      items.push({src: src, caption: $img.attr('title') || '', type: 'image'});
      $a.on('click', function(e) {
        e.preventDefault();
        index = i;
        showPopup(index);
      });
    });

    function showPopup(i) {
      var item = items[i];
      var $img = $('<img src="' + item.src + '" style="max-width: 100%; height: auto; touch-action: auto;" />');
      $pic.empty().append($img);
      $body.append($overlay.fadeTo(settings.popupSpeed, settings.overlayOpacity));
      $body.append($popup.fadeIn(settings.popupSpeed));
    }

    function closePopup() {
      $popup.fadeOut(settings.popupSpeed);
      $overlay.fadeOut(settings.popupSpeed);
    }

    $closer.on('click', function(e) {
      e.stopPropagation();
      closePopup();
    });

    $overlay.on('click', function(e) {
      e.stopPropagation();
      closePopup();
    });

    return this;
  };
})(jQuery);